
# ===========================================================================
# this code is to to delete ssh tunnel between local server and remote server
# delete by killing the related process
# Main steps:
# 1. delete by killing the related process
# xxxxxxxxxxxxxxxxxxxxx 2. delete the sshtunnel_user
# ===========================================================================


# delete ssh tunnel by stop the process
- name: Show previous sessions on local dest port
  # this command only to check port status, and it cannot kill ports
  shell: "ps axuf | grep {{ sshforwarding.local_port }} | grep ssh | awk '{print \"kill -9 \" $2}'"
  register: port_process

- name: Kill previous sessions on local dest port
  shell: "{{ port_process_item }}"
  with_items:
    - "{{ port_process.stdout_lines }}"
  loop_control:
    loop_var: port_process_item

# - name: Remove ssh user
#   user:
#     name: "{{ sshtunnel_user }}"
#     state: absent
#     remove: yes
